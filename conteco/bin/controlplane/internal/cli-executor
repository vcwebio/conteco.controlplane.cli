#!/usr/bin/env bash
(
	export CONTECO_CONTROLPLANE="$1"
	shift
	noSelection="true"
	if [[ "$1" == "console" ]] ; then
		echo "$CONTECO_CONTROLPLANE $@"
		if [[ "$CONTECO_COMMAND_OUTPUT" == "silent" ]] ; then
		  docker run -v /var/run/docker.sock:/var/run/docker.sock -v controlplane_repos:/conteco/pwd ${CONTECO_REGISTRY}${CONTECO_REALM}/${CONTECO_ECOSYSTEM}.controlplane.${CONTECO_CONTROLPLANE} --interactive .invoke $@ > /dev/null
		else
		  docker run -v /var/run/docker.sock:/var/run/docker.sock -v controlplane_repos:/conteco/pwd ${CONTECO_REGISTRY}${CONTECO_REALM}/${CONTECO_ECOSYSTEM}.controlplane.${CONTECO_CONTROLPLANE} --interactive .invoke $@ > >( output-parser-tagged ) 2> >( output-parser-tagged );
			wait-for-output-parser-tagged
		fi
	else
		selector=$(set-selector "$1")
		shift
		shopt -s nullglob
		if [[ $selector == *"$" ]] ; then
			selector="${selector::-1}"
		else
			selector="$selector*"
		fi
	  # to be restricted to repo, config and build only
	  for f in $selector ;
	  do
			echo "$CONTECO_CONTROLPLANE $@ $f"
	    noSelection="false"
			if [[ "$CONTECO_COMMAND_OUTPUT" == "silent" ]] ; then
				docker run -v /var/run/docker.sock:/var/run/docker.sock -v controlplane_repos:/conteco/pwd ${CONTECO_REGISTRY}${CONTECO_REALM}/${CONTECO_ECOSYSTEM}.controlplane.${CONTECO_CONTROLPLANE} --interactive .invoke $@ $f > /dev/null
			else
				docker run -v /var/run/docker.sock:/var/run/docker.sock -v controlplane_repos:/conteco/pwd ${CONTECO_REGISTRY}${CONTECO_REALM}/${CONTECO_ECOSYSTEM}.controlplane.${CONTECO_CONTROLPLANE} --interactive .invoke $@ $f > >( output-parser-tagged ) 2> >( output-parser-tagged );
				wait-for-output-parser-tagged
			fi
	  done;
	fi
)
