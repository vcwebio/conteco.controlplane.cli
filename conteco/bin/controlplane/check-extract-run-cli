#!/usr/bin/env bash
# $1 current working directory
# $2 windows / linux / sudo
# $3 script
# $4 continue
export PATH="/conteco/bin/controlplane/internal:$CONTECO_EXECUTIONPLANE_ORIGINALPATH"
echo ""
echo ""

# cold start without arguments
if [[ "$2" == "" || " windows linux sudo " != *"$2"* ]] ; then
  . message-startup-arguments
  exit 0
fi

# Generate cli and cli.bat if missing
if [[ ! -f /conteco/pwd/cli || ! -f /conteco/pwd/cli.bat ]] ; then
  . generate-start-scripts "$2"
  . generate-cli-scripts "$2"
  exit 0
fi

# check and manage existing controlplane_repos data volume
hasVolume=$(docker volume ls | grep controlplane_repos | wc -l)
if (( $hasVolume > 0 )) ; then
  . manage-existing-volume "$4"
fi

# create new controlplane_repos volume if required
hasVolume=$(docker volume ls | grep controlplane_repos | wc -l)
if (( $hasVolume < 1 )) ; then
  . create-new-volume "$1" "$2"
fi

# setting CONTECO_REALM_RUNTIME
. set-runtime-realm "$4" "$5"

# run cli executor
. run-cli-executor
